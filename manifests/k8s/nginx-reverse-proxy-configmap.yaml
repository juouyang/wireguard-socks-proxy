apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-reverse-proxy
  namespace: edge-newpark
data:
  default.conf.template: |
    server {
      listen 80 default_server;
      server_name _;
      root /usr/share/nginx/html;
      index index.html;
      error_log /var/log/nginx/error.log warn;

      # 網頁：/ 會 fallback 到 index.html
      location / {
        try_files $uri $uri/ /index.html;
      }

      # HLS 串流：/cam1/stream.m3u8、/cam1/streamXX.ts
      location /cam1/ {
        alias /var/local/cam1/;
        autoindex off;
      }

      # Switch ON
      location /switch/on {
        if ($arg_token != "${SWITCH_TOKEN}") {
          return 401;
        }
        proxy_pass ${SWITCH_ON_URL};
      }

      # Switch OFF
      location /switch/off {
        if ($arg_token != "${SWITCH_TOKEN}") {
          return 401;
        }
        proxy_pass ${SWITCH_OFF_URL};
      }

      # 健康檢查
      location /healthz {
          access_log off;
          default_type text/plain;
          return 200 "ok\n";
      }
    }

  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
    <meta charset="utf-8">
    <title>Camera Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    </head>
    <body>
    <video id="video" controls autoplay muted style="width: 100%; max-width: 800px;"></video>
    <script>
      var video = document.getElementById('video');
      var videoSrc = '/cam1/stream.m3u8';
      if (Hls.isSupported()) {
          var hls = new Hls({ enableWorker: true, lowLatencyMode: true });
          hls.loadSource(videoSrc);
          hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = videoSrc;
      }
    </script>
    </body>
    </html>
